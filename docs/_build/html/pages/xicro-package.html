<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xicro Package &mdash; MBSE-2022-1/Firmware-Team 1.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Calibration Package" href="calibration-package.html" />
    <link rel="prev" title="ROS2 Setup" href="ros2-setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MBSE-2022-1/Firmware-Team
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Hardwares and Connection:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="microcontroller.html">Microcontroller</a></li>
<li class="toctree-l1"><a class="reference internal" href="hub-motor-and-driver.html">Hub Motor and Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="imu-sensor.html">IMU Sensor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Microcontroller Subsystem:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hub-motor-interface.html">Hub Motor Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="imu-interface.html">IMU Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="wheel-velocity-estimation.html">Wheel Velocity Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="forward-kinematics.html">Forward Kinematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="inverse-kinematics.html">Inverse Kinematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="wheel-odometry-computation.html">Wheel Odometry Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="ros2-interface.html">ROS2 Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ROS2:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ros2-setup.html">ROS2 Setup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Xicro Package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#create-custom-message-for-microcontroller-interface">Create custom message for microcontroller interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup-parameter-in-setup-xicro-yaml">Setup parameter in setup_xicro.yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-xicro-library-for-microcontroller">Create xicro library for microcontroller</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-xicro-node">Create xicro node</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-navigation-message-publisher-node">Create navigation message publisher node</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="calibration-package.html">Calibration Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="step-to-open.html">Steps to open ROS2 nodes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dummy1.html">Dummy 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="manipulator-firmware.html">Manipulator Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="mobile-robot-firmware.html">Mobile Robot Firmware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">File:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hardware-uses.html">Hardware Uses</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware-references.html">Hardware References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MBSE-2022-1/Firmware-Team</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Xicro Package</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/xicro-package.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="xicro-package">
<h1>Xicro Package<a class="headerlink" href="#xicro-package" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="https://github.com/imchin/Xicro">Xicro</a> is ROS2 package for microcontroller interface originally made for replacing micro-ROS.
Xicro allows the developers to use the generated libraries for the microcontrollers as well as auto-generated node that intrepreter
information from/to the microcontrollers via UART. In this documentation, Xicro is used for transmit navigation message from microcontroller
to ROS2 including Odometry and Imu measurement. Also from ROS2 to microcontroller including Twist for robot velocity command.</p>
<div class="section" id="create-custom-message-for-microcontroller-interface">
<h2>Create custom message for microcontroller interface<a class="headerlink" href="#create-custom-message-for-microcontroller-interface" title="Permalink to this heading"></a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">xicro_interfaces/msg</span></code> directory, create 3 new files for navigation message including <code class="docutils literal notranslate"><span class="pre">Odometry.msg</span></code>, <code class="docutils literal notranslate"><span class="pre">Imu.msg</span></code> and
<code class="docutils literal notranslate"><span class="pre">DiffDriveTwist.msg</span></code> then write below codes to each file to create custom message.</p>
<p>Type: xicro_interfaces/msg/Odometry</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xicro_interfaces</span><span class="o">/</span><span class="n">Pose</span> <span class="n">pose</span>
<span class="n">xicro_interfaces</span><span class="o">/</span><span class="n">Twist</span> <span class="n">twist</span>
</pre></div>
</div>
<p>Type: xicro_interfaces/msg/Imu</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xicro_interfaces</span><span class="o">/</span><span class="n">Quaternion</span> <span class="n">orientation</span>
<span class="n">xicro_interfaces</span><span class="o">/</span><span class="n">Vector3</span> <span class="n">angular_velocity</span>
<span class="n">xicro_interfaces</span><span class="o">/</span><span class="n">Vector3</span> <span class="n">linear_acceleration</span>
</pre></div>
</div>
<p>Type: xicro_interfaces/msg/DiffDriveTwist</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">float32</span> <span class="n">linear</span>
<span class="n">float32</span> <span class="n">angular</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-parameter-in-setup-xicro-yaml">
<h2>Setup parameter in setup_xicro.yaml<a class="headerlink" href="#setup-parameter-in-setup-xicro-yaml" title="Permalink to this heading"></a></h2>
<p>In xicro yaml file, Set Baudrate to <code class="docutils literal notranslate"><span class="pre">576000</span></code> for a highest transmission rate of Xicro, then declare topics for all navigation
messages in <code class="docutils literal notranslate"><span class="pre">Setup_Publisher</span></code> and <code class="docutils literal notranslate"><span class="pre">Setup_Subscriber</span></code>. Microcontroller port is set to <code class="docutils literal notranslate"><span class="pre">/dev/ttyACM0</span></code> from <a class="reference internal" href="ros2-setup.html#mcuport"><span class="std std-ref">Hardware setup</span></a>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">Idmcu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w"></span>
<span class="nt">Namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sub_N_pub&quot;</span><span class="w"></span>
<span class="nt">Port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/ttyACM0&quot;</span><span class="w"></span>
<span class="nt">generate_library_Path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;xicro/libraries&quot;</span><span class="w"></span>
<span class="nt">Baudrate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">576000</span><span class="w"></span>
<span class="nt">Setup_Publisher</span><span class="p">:</span><span class="w">  </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="s">&quot;nav_stm32&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;xicro_interfaces/Odometry.msg&quot;</span><span class="p p-Indicator">],</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="s">&quot;imu_stm32&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;xicro_interfaces/Imu.msg&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="nt">Setup_Subscriber</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="s">&quot;cmd_vel_stm32&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;xicro_interfaces/DiffDriveTwist.msg&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="nt">Setup_Srv_client</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="create-xicro-library-for-microcontroller">
<h2>Create xicro library for microcontroller<a class="headerlink" href="#create-xicro-library-for-microcontroller" title="Permalink to this heading"></a></h2>
<p>After yaml config, The stm32 library will be generated based on setup_xicro.yaml when run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">run</span> <span class="n">xicro_pkg</span> <span class="n">generate_library</span><span class="o">.</span><span class="n">py</span> <span class="n">stm32</span> <span class="n">stm32h7xx_hal</span><span class="o">.</span><span class="n">h</span>
</pre></div>
</div>
<p>Stm32 library will be generated in <code class="docutils literal notranslate"><span class="pre">~/xicro/libraries</span></code>. So you need to bring this <code class="docutils literal notranslate"><span class="pre">.h</span></code> and <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> to your stm32 project.</p>
</div>
<div class="section" id="create-xicro-node">
<h2>Create xicro node<a class="headerlink" href="#create-xicro-node" title="Permalink to this heading"></a></h2>
<p>The node will be generated based on setup_xicro.yaml when run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">run</span> <span class="n">xicro_pkg</span> <span class="n">generate_xicro_node</span><span class="o">.</span><span class="n">py</span> <span class="n">stm32</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>After running the command, VScode will display the node that was created.
Delete line 11 <code class="docutils literal notranslate"><span class="pre">!Delete</span> <span class="pre">this</span> <span class="pre">line</span> <span class="pre">to</span> <span class="pre">verify</span> <span class="pre">the</span> <span class="pre">code.</span></code> and save it The entry point is add auto by command.</p>
</div>
</div>
<div class="section" id="create-navigation-message-publisher-node">
<h2>Create navigation message publisher node<a class="headerlink" href="#create-navigation-message-publisher-node" title="Permalink to this heading"></a></h2>
<p>This node is not an native xicro node. It’s made in <code class="docutils literal notranslate"><span class="pre">xicro_pkg/scripts</span></code> just to create interface node between microcontroller and ROS2 in order
to publish and subscribe navigation message. These are all interface topics and files in <code class="docutils literal notranslate"><span class="pre">nav_msg_publisher</span></code> node:</p>
<ul class="simple">
<li><p>Navigation Interface</p>
<ul>
<li><p>Publish Topic</p>
<ul>
<li><p>/imu/data (sensor_msgs/msg/Imu)</p></li>
<li><p>/wheel/odometry (nav_msgs/msg/Odometry)</p></li>
</ul>
</li>
<li><p>Subscribe Topic</p>
<ul>
<li><p>/cmd_vel (geometry_msgs/msg/Twist)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Microcontroller Interface</p>
<ul>
<li><p>Publish Topic</p>
<ul>
<li><p>/cmd_vel_stm32 (xicro_interfaces/msg/DiffDriveTwist)</p></li>
</ul>
</li>
<li><p>Subscribe Topic</p>
<ul>
<li><p>/imu_stm32 (xicro_interfaces/msg/Imu)</p></li>
<li><p>/nav_stm32 (xicro_interfaces/msg/Odometry)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Imu Calibration Interface</p>
<ul>
<li><p>Yaml file</p>
<ul>
<li><p>calibration/config/sensor_properties.yaml</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>In <code class="docutils literal notranslate"><span class="pre">nav_msg_publisher.py</span></code>, create yaml file interface to load imu sensor properties from calibration-package:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load Imu calibration value from Yaml file</span>
<span class="n">calibration_gen_path</span> <span class="o">=</span> <span class="n">get_package_share_directory</span><span class="p">(</span><span class="s1">&#39;calibration&#39;</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calibration_gen_path</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="s1">&#39;sensor_properties.yaml&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">UnsafeLoader</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load IMU calibration file: &#39;sensor_properties.yaml&#39; in share calibration package Success...&quot;</span><span class="p">)</span>

<span class="c1"># Set imu calibration value from yaml file</span>
<span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_x_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_y_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_z_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_x_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_y_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_z_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
<span class="c1"># Set imu variance from yaml file</span>
<span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_x_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_y_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_z_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_x_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_y_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">][</span><span class="mi">28</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_z_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">][</span><span class="mi">35</span><span class="p">]</span>
</pre></div>
</div>
<p>After receiving imu message from microcontroller, create <code class="docutils literal notranslate"><span class="pre">callback_imu_stm32</span></code> to calibrate imu raw data with sensor properties
and make standard ros2 imu message (sensor_msgs/msg/Imu)</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">callback_imu_stm32</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">:</span><span class="n">imu</span><span class="p">):</span>
    <span class="c1"># Assign value from imu msg to node internal value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imu_orientation</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">orientation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imu_angular_velocity</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">angular_velocity</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imu_linear_acceleration</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">linear_acceleration</span>
    <span class="c1"># Publish Imu to navigation (with same rate of controller)</span>
    <span class="n">imu_msg</span> <span class="o">=</span> <span class="n">Imu</span><span class="p">()</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span><span class="o">=</span><span class="s2">&quot;base_footprint&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">to_msg</span><span class="p">()</span>

    <span class="c1"># Linear acceleration</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">linear_acceleration</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_linear_acceleration</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_x_bias</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">linear_acceleration</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_linear_acceleration</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_y_bias</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">linear_acceleration</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_linear_acceleration</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_z_bias</span>

    <span class="c1"># Angular velocity</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">angular_velocity</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_angular_velocity</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_x_bias</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">angular_velocity</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_angular_velocity</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_y_bias</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">angular_velocity</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_angular_velocity</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_z_bias</span>

    <span class="c1"># Orientation</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_orientation</span><span class="o">.</span><span class="n">x</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_orientation</span><span class="o">.</span><span class="n">y</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_orientation</span><span class="o">.</span><span class="n">z</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imu_orientation</span><span class="o">.</span><span class="n">w</span>

    <span class="n">imu_msg</span><span class="o">.</span><span class="n">linear_acceleration_covariance</span> <span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_x_var</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_y_var</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_acc_z_var</span><span class="p">]</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">angular_velocity_covariance</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_x_var</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_y_var</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ang_vel_z_var</span><span class="p">]</span>
    <span class="n">imu_msg</span><span class="o">.</span><span class="n">orientation_covariance</span><span class="o">=</span><span class="p">[</span><span class="mf">0.000000001</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.000000001</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.000000001</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">imu_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">imu_msg</span><span class="p">)</span>
</pre></div>
</div>
<p>After receiving odometry message from microcontroller, create <code class="docutils literal notranslate"><span class="pre">callback_nav_stm32</span></code> to fill original data with pose covariance and
twist covariance to make standard odometry message (nav_msgs/msg/odometry)</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">callback_nav_stm32</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">:</span><span class="n">odom</span><span class="p">):</span>
    <span class="c1"># Assign value from odom msg to node internal value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">twist</span>
    <span class="c1"># Publish Odometry to navigation (with same rate of controller)</span>
    <span class="n">odom_msg</span> <span class="o">=</span> <span class="n">Odometry</span><span class="p">()</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span><span class="o">=</span><span class="s2">&quot;odom&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">to_msg</span><span class="p">()</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">child_frame_id</span><span class="o">=</span><span class="s2">&quot;base_footprint&quot;</span>

    <span class="c1"># PoseWithCovariance</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span>

    <span class="n">odom_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,]</span>
    <span class="c1"># TwistWithCovariance</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">z</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">x</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">y</span>
    <span class="n">odom_msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>

    <span class="n">odom_msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00477649365</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0530721471</span><span class="p">,]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">wheel_odometry_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">odom_msg</span><span class="p">)</span>
</pre></div>
</div>
<p>When navigation node send command velocity to control mobile robot, <code class="docutils literal notranslate"><span class="pre">cmd_vel_callback</span></code> will extract only linear velocity of x and
angular velocity of z to make custom twist message then sent to microcontroller via Xicro.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cmd_vel_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">:</span><span class="n">Twist</span><span class="p">):</span>
    <span class="c1"># Assign value from twist msg to node internal value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot_cmd_vel</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot_cmd_vel</span><span class="o">.</span><span class="n">angular</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
    <span class="c1"># Publish DiffDriveTwist to robot (with same rate of command velocity)</span>
    <span class="n">twist_msg</span> <span class="o">=</span> <span class="n">DiffDriveTwist</span><span class="p">()</span>
    <span class="n">twist_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_cmd_vel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot_twist_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">twist_msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ros2-setup.html" class="btn btn-neutral float-left" title="ROS2 Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="calibration-package.html" class="btn btn-neutral float-right" title="Calibration Package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, VeroAlfa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>